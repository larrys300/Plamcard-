<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Éditeur d'Invitation Fusionné</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&family=Courier+Prime&family=Montserrat:wght@400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            /* Couleurs par défaut (style Photo 1) */
            --admin-bg: #f0f2f5;
            --admin-panel: #ffffff;
            --card-bg: #0a0e14;
            --accent-color: #00ff9d;
            --text-color: #ffffff;
            --secondary-text: #8899a6;
            --main-font: 'Poppins', sans-serif; 
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: var(--main-font); }

        body {
            display: flex;
            height: 100vh;
            background-color: var(--admin-bg);
            color: #333;
            overflow: hidden;
        }

        /* --- COLONNE GAUCHE : ÉDITEUR (Simple) --- */
        .editor-panel {
            width: 400px;
            background: var(--admin-panel);
            padding: 2rem;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
            height: 100%;
        }

        h2 { font-size: 1.1rem; color: #333; margin-top: 1rem; margin-bottom: 0.5rem; padding-bottom: 5px; border-bottom: 2px solid #eee; }
        h3 { font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }

        .form-group { display: flex; flex-direction: column; gap: 0.3rem; }
        .form-group label { font-size: 0.8rem; font-weight: 600; color: #555; }
        
        input[type="text"], input[type="date"], input[type="time"], textarea, select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            outline: none;
            font-family: var(--main-font); 
        }
        textarea { resize: vertical; font-family: 'Courier Prime', monospace; }

        .color-picker-group, .file-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border-radius: 6px;
        }
        input[type="color"] {
            border: none;
            width: 40px;
            height: 40px;
            cursor: pointer;
        }
        input[type="file"] { border: 1px solid #ddd; padding: 5px; border-radius: 6px; }

        .btn-group { display: flex; gap: 10px; flex-direction: column; margin-top: 1.5rem; }
        
        button {
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
        }
        
        .btn-primary { background: linear-gradient(90deg, #8e2de2, #4a00e0); color: white; }
        .btn-success { background: linear-gradient(90deg, #11998e, #38ef7d); color: white; }
        .btn-info { background: linear-gradient(90deg, #2b6cb0, #4c99e0); color: white; } /* Nouveau style pour PDF */

        .btn-primary:hover, .btn-success:hover, .btn-info:hover { opacity: 0.9; transform: translateY(-1px); }


        /* --- PRÉVISUALISATION --- */
        .preview-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #dfe1e6;
            background-image: radial-gradient(#ccc 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: auto;
            position: relative;
        }

        /* --- CARTE --- */
        #invitation-card {
            width: 350px;
            background-color: var(--card-bg);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            
            color: var(--text-color);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            position: relative;
            text-align: center;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.5); /* Ombre interne */
            font-family: var(--main-font); 
        }
        /* Masque noir semi-transparent par dessus l'image de fond pour garder le texte lisible */
        .card-overlay {
            background: rgba(0,0,0,0.3); 
            width: 100%;
            height: 100%;
            border-radius: 20px;
        }
        .card-top { padding: 30px 20px 20px 20px; }
        .sub-header { color: var(--accent-color); font-size: 0.7rem; letter-spacing: 2px; font-weight: 700; text-transform: uppercase; margin-bottom: 10px;}
        .main-title { font-size: 2rem; line-height: 1.1; margin-bottom: 15px; font-weight: 700; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .datetime-info { display: flex; justify-content: center; gap: 10px; font-size: 0.85rem; margin-bottom: 10px; color: #ddd; }
        .datetime-info i { color: var(--accent-color); }
        .divider { height: 2px; border-top: 2px dashed rgba(255,255,255,0.3); position: relative; margin: 0; }
        .divider::before, .divider::after { content: ''; position: absolute; top: -10px; width: 20px; height: 20px; background-color: #dfe1e6; border-radius: 50%; z-index: 5; }
        .divider::before { left: -10px; }
        .divider::after { right: -10px; }
        .card-bottom { padding: 25px 20px; }
        .qr-box { background: white; padding: 8px; border-radius: 10px; display: inline-block; margin-bottom: 15px; }
        .qr-box img { width: 120px; height: 120px; display: block; }
        .guest-name { font-size: 1.4rem; font-weight: 600; color: var(--accent-color); margin: 5px 0 20px 0; text-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .location { background: rgba(255,255,255,0.1); backdrop-filter: blur(5px); padding: 10px; border-radius: 10px; font-size: 0.8rem; display: flex; align-items: center; gap: 10px; text-align: left; border: 1px solid rgba(255,255,255,0.1); }
        .location i { font-size: 1.2rem; color: var(--accent-color); }

        /* Loader pour le Mode Série */
        #loading-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.8);
            color: white;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <h3 id="loading-text">Génération en cours...</h3>
    </div>

    <div class="editor-panel">
        
        <h3><i class="fas fa-edit"></i> Configuration de l'événement</h3>
        
        <div class="form-group">
            <label>Titre de l'événement</label>
            <input type="text" id="inputTitle" value="Mon Anniversaire">
        </div>
        
        <div class="form-group">
            <label>Date et Heure</label>
            <input type="date" id="inputDate" value="2025-12-15">
            <input type="time" id="inputTime" value="19:30">
        </div>

        <div class="form-group">
            <label>Lieu / Adresse</label>
            <input type="text" id="inputLocation" value="Le Grand Hôtel">
        </div>
        <div class="form-group">
            <label>Contact / RSVP</label>
            <input type="text" id="inputContact" value="RSVP avant le 01/12">
        </div>

        <h2><i class="fas fa-palette"></i> Design & Couleurs</h2>

        <div class="form-group file-group">
            <label>Image de fond (Optionnel)</label>
            <input type="file" id="inputBgImage" accept="image/*">
        </div>
        
        <div class="form-group">
            <label>Police de caractère</label>
            <select id="inputFontFamily">
                <option value="Poppins, sans-serif">Moderne (Poppins)</option>
                <option value="Montserrat, sans-serif">Propre (Montserrat)</option>
                <option value="'Playfair Display', serif">Élégante (Playfair Display)</option>
            </select>
        </div>

        <div class="form-group">
            <label>Couleur d'accentuation (Néon)</label>
            <input type="color" id="inputAccentColor" value="#00ff9d" style="width:100%; height:40px;">
        </div>

        <div class="form-group">
            <label>Couleur de fond (Si pas d'image)</label>
            <input type="color" id="inputBgColor" value="#0a0e14" style="width:100%; height:40px;">
        </div>

        <h2><i class="fas fa-users"></i> Mode Série (Production)</h2>
        
        <div class="form-group">
            <label>Nom de l'invité (Pour la prévisualisation)</label>
            <input type="text" id="inputGuest" value="Monsieur Alain">
        </div>

        <div class="form-group">
            <label>Liste des invités (Un nom par ligne)</label>
            <textarea id="guestList" rows="5" placeholder="Jean Dupont&#10;Marie Curie&#10;Albert Einstein"></textarea>
        </div>
        
        <div class="btn-group">
            <button class="btn-info" onclick="generatePDF()">
                <i class="fas fa-file-pdf"></i> Télécharger l'invitation (PDF)
            </button>
            
            <button class="btn-primary" onclick="generateSingle()">
                <i class="fas fa-download"></i> Télécharger l'invitation (PNG)
            </button>
            <button class="btn-success" onclick="generateBatch()">
                <i class="fas fa-file-archive"></i> Générer en masse (ZIP de PNG)
            </button>
        </div>
    </div>

    <div class="preview-area">
        
        <div id="invitation-card">
            <div class="card-overlay">
                <div class="card-top">
                    <div class="sub-header">INVITATION OFFICIELLE</div>
                    <div class="main-title" id="dispTitle">Mon<br>Anniversaire</div>
                    
                    <div class="datetime-info">
                        <span id="dispDate"><i class="far fa-calendar-alt"></i> 15 Déc. 2025</span>
                        <span id="dispTime"><i class="far fa-clock"></i> 19:30</span>
                    </div>
                </div>

                <div class="divider"></div>

                <div class="card-bottom">
                    <div class="qr-box">
                        <img id="qrImage" src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=Demo" alt="QR Code">
                    </div>

                    <div class="guest-label" style="font-size: 0.7rem; opacity: 0.7; letter-spacing: 1px;">INVITÉ D'HONNEUR</div>
                    <div class="guest-name" id="dispGuest">Monsieur Alain</div>
                    
                    <div class="location">
                        <i class="fas fa-map-marker-alt"></i>
                        <div>
                            <div style="font-weight:700; color:var(--accent-color)">Lieu de l'événement</div>
                            
                            <div id="dispLocation" style="font-size:0.7rem; opacity:0.8">Le Grand Hôtel</div>
                            <div id="dispContact" style="font-size:0.7rem; opacity:0.8">RSVP avant le 01/12</div>
                        </div>
                        
                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <script>
        const root = document.documentElement;
        const dispTimeElement = document.getElementById('dispTime');

        // --- Fonctions de Live Preview (Inchangées) ---
        document.getElementById('inputBgImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('invitation-card').style.backgroundImage = `url(${event.target.result})`;
                }
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('inputTitle').addEventListener('input', (e) => {
            document.getElementById('dispTitle').innerHTML = e.target.value.replace(' ', '<br>');
        });
        document.getElementById('inputGuest').addEventListener('input', (e) => {
            document.getElementById('dispGuest').innerText = e.target.value;
            updateQrCode(e.target.value); 
        });
        document.getElementById('inputLocation').addEventListener('input', (e) => {
            document.getElementById('dispLocation').innerText = e.target.value;
        });
        document.getElementById('inputContact').addEventListener('input', (e) => {
            document.getElementById('dispContact').innerText = e.target.value;
        });
        document.getElementById('inputFontFamily').addEventListener('change', (e) => {
            root.style.setProperty('--main-font', e.target.value);
        });
        document.getElementById('inputAccentColor').addEventListener('input', (e) => {
            root.style.setProperty('--accent-color', e.target.value);
        });
        document.getElementById('inputBgColor').addEventListener('input', (e) => {
            root.style.setProperty('--card-bg', e.target.value);
            document.getElementById('invitation-card').style.backgroundImage = 'none'; 
        });
        
        const dispDate = document.getElementById('dispDate');
        document.getElementById('inputDate').addEventListener('input', (e) => {
            const dateObj = new Date(e.target.value + 'T00:00:00'); 
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            dispDate.innerHTML = `<i class="far fa-calendar-alt"></i> ` + dateObj.toLocaleDateString('fr-FR', options).replace('.', '');
        });
        document.getElementById('inputTime').addEventListener('input', (e) => {
            dispTimeElement.innerHTML = `<i class="far fa-clock"></i> ` + e.target.value;
        });


        // --- Fonctions de Génération (MODIFIÉES pour une fiabilité maximale) ---

        /**
         * Met à jour le nom de l'invité et le QR code, et retourne une Promise
         * qui se résout uniquement lorsque l'image du QR code est chargée et que le navigateur a eu le temps de la rendre.
         * @param {string} name 
         * @returns {Promise<void>}
         */
        function updateCardData(name) {
            document.getElementById('dispGuest').innerText = name;
            const qrImage = document.getElementById('qrImage');
            
            return new Promise(resolve => {
                
                // Si l'image est déjà chargée (cache), on passe tout de suite à la résolution.
                if (qrImage.complete && qrImage.naturalHeight !== 0 && qrImage.src.includes(encodeURIComponent(name))) {
                    setTimeout(resolve, 50); // Petit délai de rendu même si en cache
                    return;
                }

                // Supprimer les écouteurs précédents (pour éviter les résolutions multiples)
                const clone = qrImage.cloneNode(true);
                qrImage.parentNode.replaceChild(clone, qrImage);
                const newQrImage = document.getElementById('qrImage');
                
                // Logique de chargement
                const onImageReady = () => {
                    newQrImage.removeEventListener('load', onImageReady);
                    newQrImage.removeEventListener('error', onImageReady);
                    // Délai de rendu critique : 150ms pour laisser le navigateur dessiner l'image
                    setTimeout(resolve, 1500); 
                };

                newQrImage.addEventListener('load', onImageReady);
                newQrImage.addEventListener('error', onImageReady); 
                
                // Mettre à jour l'URL (déclenche le chargement)
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=Ticket-${encodeURIComponent(name)}`;
                newQrImage.src = qrUrl;
            });
        }

        // Utilisé uniquement pour la prévisualisation en direct, n'a pas besoin d'attendre.
        function updateQrCode(data) {
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=Ticket-${encodeURIComponent(data)}`;
            document.getElementById('qrImage').src = qrUrl;
        }

        function captureCard() {
            const style = document.createElement('style');
            style.innerHTML = `.divider::before, .divider::after { opacity: 0 !important; }`;
            document.head.appendChild(style);

            return html2canvas(document.getElementById('invitation-card'), {
                backgroundColor: null, 
                scale: 2 
            }).then(canvas => {
                document.head.removeChild(style); 
                return canvas;
            });
        }

        // 1. GÉNÉRER UNE SEULE INVITATION (PNG)
        async function generateSingle() {
            const name = document.getElementById('inputGuest').value;
            
            // 1. Attendre que le QR code soit chargé ET rendu
            await updateCardData(name);
            
            // 2. Capturer et télécharger
            captureCard().then(canvas => {
                canvas.toBlob(function(blob) {
                    saveAs(blob, `Invitation-${name.replace(/[^a-z0-9]/gi, '_')}.png`);
                });
            });
        }

        // 2. GÉNÉRER EN MASSE (ZIP de PNG)
        async function generateBatch() {
            const rawList = document.getElementById('guestList').value;
            const names = rawList.split('\n').filter(n => n.trim() !== '');

            if(names.length === 0) {
                alert("Veuillez entrer au moins un nom dans la liste pour le mode série !");
                return;
            }

            const zip = new JSZip();
            const overlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');

            overlay.style.display = 'flex';

            for (let i = 0; i < names.length; i++) {
                const name = names[i].trim();
                loadingText.innerText = `Génération ${i+1}/${names.length} : ${name}`;
                
                // 1. Mettre à jour, forcer le rechargement et ATTENDRE LE RENDU du QR CODE
                await updateCardData(name);

                // 2. Capturer l'image
                const canvas = await captureCard();
                
                // 3. Convertir en BLOB
                const blob = await new Promise(resolve => canvas.toBlob(resolve));
                
                // 4. Ajouter au zip
                zip.file(`Invitation-${name.replace(/[^a-z0-9]/gi, '_')}.png`, blob);
            }

            loadingText.innerText = "Création du fichier ZIP...";
            
            // 5. Télécharger le ZIP final
            zip.generateAsync({type:"blob"}).then(function(content) {
                saveAs(content, "Invitations_en_masse.zip");
                overlay.style.display = 'none';
                // Remettre le nom initial dans la prévisualisation
                updateCardData(document.getElementById('inputGuest').value);
            });
        }
        
        // 3. GÉNÉRER PDF
        async function generatePDF() {
            const name = document.getElementById('inputGuest').value;
            const { jsPDF } = window.jspdf; // Accéder à jsPDF

            // 1. Attendre que le QR code soit chargé ET rendu
            await updateCardData(name);
            
            // 2. Capturer
            captureCard().then(canvas => {
                
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 80; 
                const imgHeight = canvas.height * imgWidth / canvas.width;

                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: [imgWidth, imgHeight + 10] 
                });

                const marginX = (pdf.internal.pageSize.getWidth() - imgWidth) / 2;
                const marginY = 5;

                pdf.addImage(imgData, 'PNG', marginX, marginY, imgWidth, imgHeight);
                pdf.save(`Invitation-${name.replace(/[^a-z0-9]/gi, '_')}.pdf`);
            });
        }


        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('inputDate').dispatchEvent(new Event('input'));
            document.getElementById('inputContact').dispatchEvent(new Event('input'));
        });
    </script>
</body>
</html>
